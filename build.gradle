plugins {
    id 'com.android.library' version libs.versions.agp apply false
    id 'org.jetbrains.kotlin.android' version libs.versions.kotlin apply false
}

tasks.register("collectAars", Copy) {
    from(subprojects.collect { subproject ->
        subproject.layout.buildDirectory.dir("outputs/aar")
    })
    into(layout.buildDirectory.dir("outputs/aar"))
}

tasks.named("collectAars") {
    dependsOn(subprojects.collectMany { sub ->
        if (gradle.startParameter.taskNames.any { it.contains("Release") }) {
            sub.tasks.matching { it.name == "bundleReleaseAar" }
        } else {
            sub.tasks.matching { it.name == "bundleDebugAar" }
        }
    })
}

subprojects { subproject ->
    tasks.matching { it.name == "assembleRelease" }.configureEach {
        finalizedBy(rootProject.tasks.named("collectAars"))
    }
    afterEvaluate {
        if (subproject.plugins.hasPlugin('com.android.library')) {
            subproject.android {
                defaultConfig {
                    minSdkVersion 21
                }
            }
        }
    }
}


